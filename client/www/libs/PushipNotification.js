//Puship Library V1.2.2 - (c)2014 SoftRay
var Puship=Puship||{};Puship.PushipAppId=null;Puship.EnableLog=false;Puship.Domain='http://puship.cloudapp.net/';Puship.gcmregid='';Puship.Events=Puship.Events||{};Puship.OS={IOS:{value:1,name:"iOS",code:"IOS"},ANDROID:{value:2,name:"Android",code:"ANDROID"},WP:{value:3,name:"Windows Phone",code:"WP"},BLACKBERRY:{value:4,name:"BlackBerry",code:"BB"}};var RESPONSESTATUS={REGISTERED:{value:200,name:"Registered",code:"REGISTERED"},GENERICERROR:{value:500,name:"Generic Error",code:"GENERICERROR"},PERMISSIONERROR:{value:400,name:"Permission Error",code:"PERMISSIONERROR"},DEVICELIMITERROR:{value:401,name:"Device Limit Error",code:"DEVICELIMITERROR"},TAGLIMITERROR:{value:402,name:"Tag Limit Error",code:"TAGLIMITERROR"},CREDENTIALERROR:{value:403,name:"Credential Error",code:"CREDENTIALERROR"},APPLICATIONNOTFOUND:{value:404,name:"Application not found",code:"APPLICATIONNOTFOUND"},DEVICENOTFOUND:{value:405,name:"Device not found",code:"DEVICENOTFOUND"}};Puship.GCM=function(){var privateInstanceIdentifier='';var privateAppId='';var privateDeviceType=-1;var privateSuccessCallback=GCM_Success;var privateFailCallback=GCM_Fail;function GCM_Event(e){Puship.Common.Log('GCM_Event: '+e.event);switch(e.event){case'registered':Puship.gcmregid=e.regid;if(Puship.gcmregid.length>0){Puship.Common.Log('REGISTERED -> REGID:'+e.regid);Puship.Common.RegisterOnPuship(e.regid,privateAppId,privateDeviceType,{instanceId:privateInstanceIdentifier,successCallback:privateSuccessCallback,failCallback:privateFailCallback});}
break;case'message':Puship.Common.Log('MESSAGE -> MSG:'+e.message);Puship.Common.Log('MESSAGE -> MSGCNT:'+e.msgcnt);Puship.Common.Log('e:'+JSON.stringify(e));if(e.payload.foreground){if(e.payload!=null){Puship.Common.Log('soundname:'+e.payload.sound);var my_media=new Media("/android_asset/www/"+e.payload.sound);my_media.play();}}else{Puship.Common.Log('inline');Puship.Common.NotifyPush(ConvertPush(e));}
break;case'error':Puship.Common.Log('ERROR -> MSG:'+e.msg);privateFailCallback(e);break;default:alert('EVENT -> Unknown, an event was received and we do not know what it is');break;}}
function GCM_Success(e){Puship.Common.Log('success method');Puship.Common.Log('e:'+JSON.stringify(e));if(e=="ALREADY REGISTERED"&&privateSuccessCallback!=GCM_Success){privateSuccessCallback(e);}
Puship.Common.Log('exit from success');}
function GCM_Fail(e){Puship.Common.Log('GCM_Fail -> GCM plugin failed to register');Puship.Common.Log('GCM_Fail -> '+e.msg);privateFailCallback(e);}
function ConvertPush(GCMPush){Puship.Common.Log("Converting GCM...");var CommonPush={Badge:GCMPush.payload==null?GCMPush.msgcnt:GCMPush.payload.msgcnt,Alert:GCMPush.message,Sound:GCMPush.payload==null?GCMPush.sound:GCMPush.payload.sound,Param1:GCMPush.payload==null?GCMPush.Param1:GCMPush.payload.Param1,Param2:GCMPush.payload==null?GCMPush.Param2:GCMPush.payload.Param2,Param3:GCMPush.payload==null?GCMPush.Param3:GCMPush.payload.Param3,Param4:GCMPush.payload==null?GCMPush.Param4:GCMPush.payload.Param4,Param5:GCMPush.payload==null?GCMPush.Param5:GCMPush.payload.Param5};Puship.Common.Log("CommonPush: "+JSON.stringify(CommonPush));return CommonPush;}
return{Register:function(GCMProject,optionalparams){Puship.Common.Log('Calling GCM Register');privateAppId=Puship.PushipAppId;privateDeviceType=2;if(!optionalparams)optionalparams={};privateSuccessCallback=Puship.Common.DefaultValue(optionalparams.successCallback,GCM_Success);privateFailCallback=Puship.Common.DefaultValue(optionalparams.failCallback,GCM_Fail);privateInstanceIdentifier=Puship.Common.DefaultValue(optionalparams.instanceId,device.uuid);Puship.Common.Log('Params initialized');var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){pushNotification.register(GCM_Success,GCM_Fail,{"senderID":GCMProject,"ecb":"Puship.GCM.GCM_Event"});}else{return cordova.exec(GCM_Success,GCM_Fail,'GCMPlugin','register',[{senderID:GCMProject,ecb:"Puship.GCM.GCM_Event"}]);}},UnRegister:function(successCallback,failureCallback){Puship.Common.Log("Start unregistering app");var UnregisterSuccessCallback=Puship.Common.DefaultValue(successCallback,function(){Puship.Common.Log("Success Unregistering app");});var UnregisterFailCallback=Puship.Common.DefaultValue(failureCallback,function(err){Puship.Common.Log("Error during Unregistering app");Puship.Common.Log("error:"+JSON.stringify(err));});var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){pushNotification.unregister(UnregisterSuccessCallback,UnregisterFailCallback);}else{Puship.Common.Log("Calling native unregister");return cordova.exec(UnregisterSuccessCallback,UnregisterFailCallback,'GCMPlugin','unregister',[{}]);}},GCM_Event:GCM_Event};}();function PushipWPNotificationCallback(pushMessage){Puship.WP.NotificationCallback(pushMessage);}
Puship.WP=function(){var privateInstanceIdentifier='';var privateAppId='';var privateDeviceType=-1;var privateSuccessCallback=GCM_Success;var privateFailCallback=GCM_Fail;function Register(optionalparams){Puship.Common.Log('Calling WP Register');privateAppId=Puship.PushipAppId;privateDeviceType=3;if(!optionalparams)optionalparams={};privateSuccessCallback=Puship.Common.DefaultValue(optionalparams.successCallback,GCM_Success);privateFailCallback=Puship.Common.DefaultValue(optionalparams.failCallback,GCM_Fail);privateInstanceIdentifier=Puship.Common.DefaultValue(optionalparams.instanceId,device.uuid);Puship.Common.Log('Params initialized');Puship.Common.Log("Getting user token");var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){Puship.Common.Log("Calling WP with CLI");pushNotification.register(RegisterResultCallBack,privateFailCallback,{"channelName":privateAppId,"ecb":"Puship.WP.NotificationCallback","uccb":"Puship.WP.channelHandler","errcb":"Puship.WP.jsonErrorHandler"});}else{Puship.Common.Log("Calling WP with normal plugin");cordova.exec(RegisterResultCallBack,privateFailCallback,"PushipPlugin","GetUserToken",[]);}}
function RegisterResultCallBack(tokenresult){Puship.Common.Log('Result token:'+JSON.stringify(tokenresult));var token="";var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){token=tokenresult.uri;}else{token=tokenresult;}
if(Puship.Common.IsNullOrEmpty(token)){var e=e||{};e.msg="URI is not Valid";privateFailCallback(e);}else{Puship.Common.RegisterOnPuship(token,privateAppId,privateDeviceType,{instanceId:privateInstanceIdentifier,successCallback:privateSuccessCallback,failCallback:privateFailCallback});}}
function GCM_Success(e){Puship.Common.Log('success method');Puship.Common.Log('e:'+JSON.stringify(e));Puship.Common.Log('exit from success');}
function GCM_Fail(e){Puship.Common.Log('GCM_Fail -> GCM plugin failed to register');Puship.Common.Log('GCM_Fail -> '+e.msg);privateFailCallback(e);}
function ConvertPush(MPNSPush){Puship.Common.Log("Converting MPNS..."+JSON.stringify(MPNSPush));var CommonPush=null;var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){if(MPNSPush.type=="toast"&&MPNSPush.jsonContent){var pr=MPNSPush.jsonContent['wp:Param'];CommonPush={Badge:Puship.Common.GetURLParameter(pr,"msgcnt"),Alert:MPNSPush.jsonContent['wp:Text2'],Sound:Puship.Common.GetURLParameter(pr,"sound"),Param1:Puship.Common.GetURLParameter(pr,"Param1"),Param2:Puship.Common.GetURLParameter(pr,"Param2"),Param3:Puship.Common.GetURLParameter(pr,"Param3"),Param4:Puship.Common.GetURLParameter(pr,"Param4"),Param5:Puship.Common.GetURLParameter(pr,"Param5")};}else{Puship.Common.Log("MPNS body... "+JSON.stringify(MPNSPush.jsonContent.Body));}}else{CommonPush={Badge:1,Alert:MPNSPush,Sound:"default"};}
Puship.Common.Log("CommonPush: "+JSON.stringify(CommonPush));return CommonPush;}
function channelHandler(par){Puship.Common.Log('channelHandler raised with: ');Puship.Common.Log("param:"+JSON.stringify(par));}
function jsonErrorHandler(par){Puship.Common.Log('jsonErrorHandler raised with:');Puship.Common.Log("param:"+JSON.stringify(par));}
function NotificationCallback(notification){Puship.Common.Log('raising puship event');Puship.Common.NotifyPush(ConvertPush(notification));}
return{Register:Register,UnRegister:function(successCallback,failureCallback){Puship.Common.Log("Start unregistering app");var UnregisterSuccessCallback=Puship.Common.DefaultValue(successCallback,function(){Puship.Common.Log("Success Unregistering app");});var UnregisterFailCallback=Puship.Common.DefaultValue(failureCallback,function(err){Puship.Common.Log("Error during Unregistering app");Puship.Common.Log("error:"+JSON.stringify(err));});Puship.Common.Log("Calling native unregister");return cordova.exec(UnregisterSuccessCallback,UnregisterFailCallback,'GCMPlugin','unregister',[{}]);},NotificationCallback:NotificationCallback,channelHandler:channelHandler,jsonErrorHandler:jsonErrorHandler};}();Puship.APNS=function(){var privateInstanceIdentifier='';var privateAppId='';var privateDeviceType=-1;var privateSuccessCallback=GCM_Success;var privateFailCallback=GCM_Fail;var privatePushCallback=PushCallback;var privateApntoken='';function PushCallback(push){Puship.Common.Log('push received');}
function GCM_Success(e){Puship.Common.Log('success method');Puship.Common.Log('e:'+JSON.stringify(e));Puship.Common.Log('exit from success');}
function GCM_Fail(e){Puship.Common.Log('GCM_Fail -> GCM plugin failed to register');Puship.Common.Log('GCM_Fail -> '+e.msg);privateFailCallback(e);}
function ConvertPush(APNPush){var CommonPush={Badge:APNPush.badge,Alert:APNPush.alert,Sound:APNPush.sound,Param1:APNPush.Param1,Param2:APNPush.Param2,Param3:APNPush.Param3,Param4:APNPush.Param4,Param5:APNPush.Param5};Puship.Common.Log("CommonPush: "+JSON.stringify(CommonPush));return CommonPush;}
return{Register:function(optionalparams){Puship.Common.Log('Calling APNS Register');privateAppId=Puship.PushipAppId;privateDeviceType=1;if(!optionalparams)optionalparams={};privateSuccessCallback=Puship.Common.DefaultValue(optionalparams.successCallback,GCM_Success);privateFailCallback=Puship.Common.DefaultValue(optionalparams.failCallback,GCM_Fail);privateInstanceIdentifier=Puship.Common.DefaultValue(optionalparams.instanceId,device.uuid);privatePushCallback=Puship.Common.DefaultValue(optionalparams.pushCallback,PushCallback);var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){Puship.Common.Log("Registering with CLI");pushNotification.register(function(resultToken){Puship.Common.Log("token: "+resultToken);privateApntoken=resultToken;Puship.Common.RegisterOnPuship(resultToken,privateAppId,privateDeviceType,{instanceId:privateInstanceIdentifier,successCallback:privateSuccessCallback,failCallback:privateFailCallback});},function(status){Puship.Common.Log('Error callback');Puship.Common.Log('registerDevice:%o',status);privateFailCallback(status);},{"badge":"true","sound":"true","alert":"true","ecb":"Puship.APNS.notificationCallback"});}else{Puship.Common.Log("Registering with Manual Installation");Puship.APNS.registerDevice({alert:true,badge:true,sound:true},function(status){Puship.Common.Log("token: "+status.deviceToken);privateApntoken=status.deviceToken;Puship.Common.Log('registerDevice:%o',status);Puship.Common.RegisterOnPuship(status.deviceToken,privateAppId,privateDeviceType,{instanceId:privateInstanceIdentifier,successCallback:privateSuccessCallback,failCallback:privateFailCallback});},function(status){Puship.Common.Log('Error callback');Puship.Common.Log('registerDevice:%o',status);privateFailCallback(status);});}},registerDevice:function(config,successCallback,errorCallback){cordova.exec(successCallback,errorCallback,"PushNotification","registerDevice",config?[config]:[]);},getPendingNotifications:function(callback){cordova.exec(callback,callback,"PushNotification","getPendingNotifications",[]);},getRemoteNotificationStatus:function(callback){cordova.exec(callback,callback,"PushNotification","getRemoteNotificationStatus",[]);},setApplicationIconBadgeNumber:function(badge,callback){var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){Puship.Common.Log("setApplicationIconBadgeNumber with CLI");pushNotification.setApplicationIconBadgeNumber(callback,callback,badge);}else{Puship.Common.Log("setApplicationIconBadgeNumber with Manual Installation");cordova.exec(callback,callback,"PushNotification","setApplicationIconBadgeNumber",[{badge:badge}]);}},cancelAllLocalNotifications:function(callback){cordova.exec(callback,callback,"PushNotification","cancelAllLocalNotifications",[]);},notificationCallback:function(notification){Puship.Common.Log('notification: '+JSON.stringify(notification));Puship.Common.Log('raising puship event');if(window.plugins.pushNotification!=null)
Puship.Common.NotifyPush(ConvertPush(notification));else
Puship.Common.NotifyPush(ConvertPush(notification.aps));},UnRegister:function(successCallback,failureCallback){Puship.Common.Log("Start unregistering apple device");var UnregisterSuccessCallback=Puship.Common.DefaultValue(successCallback,function(){Puship.Common.Log("Success Unregistering apple device");});var UnregisterFailCallback=Puship.Common.DefaultValue(failureCallback,function(err){Puship.Common.Log("Error during Unregistering apple device");Puship.Common.Log("error:"+JSON.stringify(err));});var pushNotification=window.plugins.pushNotification;if(pushNotification!=null){Puship.Common.Log("Unregistering with push plugin");pushNotification.unregister(UnregisterSuccessCallback,UnregisterFailCallback);}else{Puship.Common.Log("Calling fake unregister");UnregisterSuccessCallback();}}};}();Puship.BPNS=function(){var privateInstanceIdentifier='';var privateAppId='';var privateDeviceType=-1;var privateSuccessCallback=null;var privateFailCallback=null;var iport=32200;var iserverUrl="";var iappId="";var imax=100;var iwakeUpPage="index.html";function REG_Success(e){Puship.Common.Log('success method');Puship.Common.Log('e:'+JSON.stringify(e));if(privateSuccessCallback){privateSuccessCallback(e);}
Puship.Common.Log('exit from success');}
function REG_Fail(e){Puship.Common.Log('BB Fail -> BB plugin failed to register');if(privateFailCallback){privateFailCallback(e);}
Puship.Common.Log('BB Fail -> BB plugin failed to register');}
function onRegister(status){Puship.Common.Log('Service call done with status: '+status);if(status==0){Puship.Common.Log("Registration done");Puship.Common.RegisterOnPuship(GetToken(),privateAppId,privateDeviceType,{instanceId:privateInstanceIdentifier,successCallback:REG_Success,failCallback:REG_Fail});}
else if(status==1){alert("push register status network error");}
else if(status==2){alert("push register status rejected by server");}
else if(status==3){alert("push register status invalid parameters");}
else if(status==-1){alert("push register status general error");}
else{alert("push register status unknown");}}
function ConvertPush(BPNPush){var CommonPush={Badge:1,Alert:blackberry.utils.blobToString(BPNPush.payload),Sound:"default"};Puship.Common.Log("CommonPush: "+JSON.stringify(CommonPush));return CommonPush;}
function onData(data){Puship.Common.Log("Push notifications received");try{Puship.Common.Log("data received: "+JSON.stringify(data));var resultpush=ConvertPush(data);Puship.Common.Log('raising puship event');Puship.Common.NotifyPush(resultpush);return 0;}
catch(err){Puship.Common.Log("error from push notification data: "+err);}}
function onSimChange(){Puship.Common.Log('handle Sim Card change');}
function OpenBISPushListener(){try{Puship.Common.Log('Calling BB services');var ops={port:iport,appId:iappId,serverUrl:iserverUrl,wakeUpPage:iwakeUpPage,maxQueueCap:imax};blackberry.push.openBISPushListener(ops,onData,onRegister,onSimChange);}
catch(err){Puship.Common.Log("Error during open listener:"+err);try{Puship.Common.Log("try shotdown listener");blackberry.push.closePushListener();}catch(er){Puship.Common.Log("error during closing listener: "+er);}}}
function GetToken(){return blackberry.identity.PIN;}
return{Register:function(port,serverUrl,appId,optionalparams){Puship.Common.Log('Initializing BPNS variables');iport=port;iserverUrl=serverUrl;iappId=appId;if(!optionalparams)optionalparams={};privateAppId=Puship.PushipAppId;privateDeviceType=4;privateSuccessCallback=optionalparams.successCallback;privateFailCallback=optionalparams.failCallback;privateInstanceIdentifier=Puship.Common.DefaultValue(optionalparams.instanceId,device.uuid);imax=Puship.Common.DefaultValue(optionalparams.max,imax);iwakeUpPage=Puship.Common.DefaultValue(optionalparams.wakeUpPage,iwakeUpPage);Puship.Common.Log('Calling BPNS Register');OpenBISPushListener();},UnRegister:function(){blackberry.push.closePushListener();}};}();Puship.Common=function(){var privateCurrentPlatform=null;function IsNullOrEmpty(value){return(!value||value==undefined||value==""||value.length==0);}
function GetURLParameter(url,name){return decodeURIComponent((new RegExp('[?|&]'+name+'='+'([^&;]+?)(&|#|;|$)').exec(url)||[,""])[1].replace(/\+/g,'%20'))||null;}
function DefaultValue(arg,def){return(typeof arg=='undefined'?def:arg);}
function GetAppId(){if(Puship.PushipAppId==null){Puship.Common.Log("PushipAppId is NOT setted");return null;}
return Puship.PushipAppId;}
function WriteResponceStatus(code){if(code==RESPONSESTATUS.REGISTERED.value){Puship.Common.Log(RESPONSESTATUS.REGISTERED.name);}
else if(code==RESPONSESTATUS.GENERICERROR.value){Puship.Common.Log(RESPONSESTATUS.GENERICERROR.name);}
else if(code==RESPONSESTATUS.APPLICATIONNOTFOUND.value){Puship.Common.Log(RESPONSESTATUS.APPLICATIONNOTFOUND.name);}
else if(code==RESPONSESTATUS.PERMISSIONERROR.value){Puship.Common.Log(RESPONSESTATUS.PERMISSIONERROR.name);}
else if(code==RESPONSESTATUS.DEVICELIMITERROR.value){Puship.Common.Log(RESPONSESTATUS.DEVICELIMITERROR.name);}
else if(code==RESPONSESTATUS.TAGLIMITERROR.value){Puship.Common.Log(RESPONSESTATUS.TAGLIMITERROR.name);}
else if(code==RESPONSESTATUS.CREDENTIALERROR.value){Puship.Common.Log(RESPONSESTATUS.CREDENTIALERROR.name);}
else if(code==RESPONSESTATUS.DEVICENOTFOUND.value){Puship.Common.Log(RESPONSESTATUS.DEVICENOTFOUND.name);}
else{Puship.Common.Log("Code not found");}}
function NotifyPush(push){Puship.Common.Log("NotifyPush Callback:"+push);var ev;Puship.Common.Log("dispatch for firefox + others");ev=document.createEvent('HTMLEvents');ev.notification=push;ev.initEvent('puship-notification',true,true,push);document.dispatchEvent(ev);Puship.Common.Log("notificationCallback dispached");}
function OnPushReceived(callback){Puship.Common.Log("setting callback");document.addEventListener("puship-notification",callback);Puship.Common.Log("setting callback done");}
function AddTagFilter(tag,optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship addfilter success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship addfilter fail managed');});var pRemovePrevTag=DefaultValue(optionalparams.removePrevTag,false);Puship.Common.Log('Adding Tag Filter...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);Puship.Common.Log('Tag:'+tag);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/AddTagFilter?AppId='"+appKey+"'&DeviceIdentifier='"+deviceId
+"'&Tag='"+tag+"'&RemovePrevTag="+pRemovePrevTag+"&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{var code=JSON.parse(request.responseText).d.AddTagFilter;if(code==200){Puship.Common.Log('Filter added succesfully');pSuccessCallBack(this);}else{Puship.Common.Log('Error during filter adding execution');WriteResponceStatus(code);pFailCallBack(this);}}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during filter adding'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling AddTagFilter endpoint');request.send();}
function RemoveTagFilter(tag,optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship removefilter success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship removefilter fail managed');});Puship.Common.Log('Removing Tag Filter...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);Puship.Common.Log('Tag:'+tag);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/RemoveTagFilter?AppId='"+appKey+"'&DeviceIdentifier='"+deviceId
+"'&Tag='"+tag+"'&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{var code=JSON.parse(request.responseText).d.RemoveTagFilter;if(code==200){Puship.Common.Log('Filter removed succesfully');pSuccessCallBack(this);}else{Puship.Common.Log('Error during filter removing execution');WriteResponceStatus(code);pFailCallBack(this);}}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during Filter removing'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling RemoveTagFilter endpoint');request.send();}
function DeletePushMessage(push_id,optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship removefilter success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship removefilter fail managed');});Puship.Common.Log('deleteing push...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);Puship.Common.Log('Push_Id:'+push_id);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/DeletePushMessages?AppId='"+appKey+"'&strPushMessageId='"+push_id
+"'&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{Puship.Common.Log(request.responseText);var pp=JSON.parse(request.responseText);var res=JSON.parse(request.responseText).d.DeletePushMessages;if(res.Error==false){Puship.Common.Log('Push deleted successfully');pSuccessCallBack(res);}else{Puship.Common.Log('Error during push delete execution');WriteResponceStatus(code);pFailCallBack(res);}}catch(e){Puship.Common.Log('Error during responce parsing: '+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during Push delete: '+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling DeletePushMessages endpoint');request.send();}
function CleanTagFilter(optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship cleanfilter success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship cleanfilter fail managed');});Puship.Common.Log('Cleaning Tag Filter...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/CleanTagFilter?AppId='"+appKey+"'&DeviceIdentifier='"+deviceId
+"'&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onload=function(){Puship.Common.Log('Processing CleanTagFilter responce');if(this.status==200||this.status==201){var code=JSON.parse(this.response).d.CleanTagFilter;if(code==200){Puship.Common.Log('Filter cleaned succesfully');pSuccessCallBack(this);}else{Puship.Common.Log('Error during filter cleaning execution');WriteResponceStatus(code);pFailCallBack(this);}}else{Puship.Common.Log('Error during filter cleaning call: '+this.statusText);pFailCallBack(this);}};request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{var code=JSON.parse(request.responseText).d.CleanTagFilter;if(code==200){Puship.Common.Log('Filter cleaned succesfully');pSuccessCallBack(this);}else{Puship.Common.Log('Error during filter cleaning execution');WriteResponceStatus(code);pFailCallBack(this);}}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during push getting'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling CleanTagFilter endpoint');request.send();}
function GetTagFilters(optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship getfilter success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship getfilter fail managed');});Puship.Common.Log('Get Tag Filters...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/GetTagFilters?AppId='"+appKey+"'&DeviceIdentifier='"+deviceId
+"'&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{pSuccessCallBack(JSON.parse(request.responseText).d);}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during filter getting'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling GetTagFilters endpoint');request.send();}
var pushOptionalParams=null;function GetPushMessages(optionalparams){if(!optionalparams){pushOptionalParams={};}
else{pushOptionalParams=optionalparams;}
if(pushOptionalParams.byCurrentPosition==true){if(pushOptionalParams.Latitude==null||pushOptionalParams.Longitude==null){if(GetCurrentOs()==Puship.OS.ANDROID){optionalparams.enableHighAccuracy=true;}
navigator.geolocation.getCurrentPosition(pushCurrentPositionSuccess,pushCurrentPositionError,optionalparams);}else{}}else{GetPushMessagesInternal(pushOptionalParams);}}
function pushCurrentPositionSuccess(position){Puship.Common.Log('Latitude: '+position.coords.latitude+'\n'+'Longitude: '+position.coords.longitude+'\n'+'Altitude: '+position.coords.altitude+'\n'+'Accuracy: '+position.coords.accuracy+'\n'+'Altitude Accuracy: '+position.coords.altitudeAccuracy+'\n'+'Heading: '+position.coords.heading+'\n'+'Speed: '+position.coords.speed+'\n'+'Timestamp: '+position.timestamp+'\n');pushOptionalParams.Latitude=position.coords.latitude;pushOptionalParams.Longitude=position.coords.longitude;GetPushMessagesInternal(pushOptionalParams);}
function pushCurrentPositionError(error){var pFailCallBack=DefaultValue(pushOptionalParams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship GetPushMessage fail managed');});Puship.Common.Log('code: '+error.code+'\n'+'message: '+error.message+'\n');pFailCallBack(error);}
function GetPushMessagesInternal(optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var privateLimit=DefaultValue(optionalparams.limit,20);var privateOffset=DefaultValue(optionalparams.offset,0);var privateTags=DefaultValue(optionalparams.tag,"");var adddevicepush=DefaultValue(optionalparams.addDevicePush,false);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship GetPushMessages success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship GetPushMessages fail managed');});var privateIncludeParams=DefaultValue(optionalparams.includeParams,false);Puship.Common.Log('Get Push Messages...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);Puship.Common.Log('Tag:'+privateTags);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"Services/Puship.svc/GetPushMessages?AppId='"+appKey+"'&DeviceType="+GetCurrentOs().value+"&Limit="+privateLimit+"&Offset="+privateOffset+"&Tags='"+privateTags+"'"+"&IncludeParams="+privateIncludeParams+"";if(adddevicepush){getstr+="&DeviceId='"+deviceId+"'";}
if(optionalparams.Latitude)getstr+="&Latitude="+optionalparams.Latitude;if(optionalparams.Longitude)getstr+="&Longitude="+optionalparams.Longitude;getstr+="&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{pSuccessCallBack(JSON.parse(request.responseText).d);}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during push getting'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling GetPushMessages endpoint');request.send();}
function GetPushMessagesByDevice(optionalparams){if(!optionalparams)optionalparams={};var appKey=Puship.PushipAppId;Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var privateLimit=DefaultValue(optionalparams.limit,20);var privateOffset=DefaultValue(optionalparams.offset,0);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship GetPushMessagesByDevice success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship GetPushMessagesByDevice fail managed');});Puship.Common.Log('Get Push Messages...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"Services/Puship.svc/GetPushMessagesByDevice?DeviceId='"+deviceId+"'&Limit="+privateLimit+"&Offset="+privateOffset;getstr+="&$format=json";Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{pSuccessCallBack(JSON.parse(request.responseText).d);}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during push getting'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling GetPushMessagesByDevice endpoint');request.send();}
function RegisterOnPuship(deviceToken,appKey,deviceType,optionalparams){Puship.Common.Log('Registering on Puship...');if(!optionalparams)optionalparams={};Puship.Common.Log('Optional params: '+JSON.stringify(optionalparams));var privateInstanceIdentifier=DefaultValue(optionalparams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(optionalparams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship success managed');});var pFailCallBack=DefaultValue(optionalparams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship fail managed');});var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+appKey);Puship.Common.Log('Token:'+deviceToken);var deviceId=appKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);Puship.Common.Log('DeviceType:'+deviceType);var getstr=Puship.Domain+"services/puship.svc/RegisterDevice?AppId='"+appKey+"'&DeviceType="+deviceType+"&Token='"+deviceToken+"'&DeviceIdentifier='"+deviceId+"'&language='en'";getstr+='&$format=json';Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){var code=JSON.parse(request.responseText).d.RegisterDevice;if(code==200){Puship.Common.Log('Registered succesfully');this.DeviceToken=deviceToken;this.DeviceId=deviceId;pSuccessCallBack(this);}else{Puship.Common.Log('Error during registration device execution');WriteResponceStatus(code);pFailCallBack(this);}}else{Puship.Common.Log('Error during registration'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling RegisterOnPuship endpoint');request.send();}
function UnRegister(optionalparams){var cOS=GetCurrentOs();if(!optionalparams)optionalparams={};if(cOS==Puship.OS.ANDROID){Puship.GCM.UnRegister(optionalparams.SuccessCallback,optionalparams.FailCallback);}
else if(cOS==Puship.OS.WP){}
else if(cOS==Puship.OS.IOS){Puship.APNS.UnRegister(optionalparams.SuccessCallback,optionalparams.FailCallback);}
else{Puship.BPNS.UnRegister();if(optionalparams.SuccessCallback)optionalparams.SuccessCallback();}}
var positionAppKey=null;var positionOptionalParams=null;function RegisterCurrentPosition(optionalparams){positionAppKey=Puship.PushipAppId;if(!optionalparams){positionOptionalParams={};}
else{positionOptionalParams=optionalparams;}
if(GetCurrentOs()==Puship.OS.ANDROID){positionOptionalParams.enableHighAccuracy=true;}
navigator.geolocation.getCurrentPosition(currentPositionSuccess,currentPositionError,positionOptionalParams);}
function currentPositionSuccess(position){Puship.Common.Log('Optional params: '+JSON.stringify(positionOptionalParams));Puship.Common.Log('Latitude: '+position.coords.latitude+'\n'+'Longitude: '+position.coords.longitude+'\n'+'Altitude: '+position.coords.altitude+'\n'+'Accuracy: '+position.coords.accuracy+'\n'+'Altitude Accuracy: '+position.coords.altitudeAccuracy+'\n'+'Heading: '+position.coords.heading+'\n'+'Speed: '+position.coords.speed+'\n'+'Timestamp: '+position.timestamp+'\n');var isodate=new Date(position.timestamp);var isodatestring=ISODateString(isodate);Puship.Common.Log("ISO date: "+isodatestring);var privateInstanceIdentifier=DefaultValue(positionOptionalParams.instanceId,device.uuid);var pSuccessCallBack=DefaultValue(positionOptionalParams.successCallback,function(pushipresult){Puship.Common.Log('Internal puship RegisterPosition success managed');});var pFailCallBack=DefaultValue(positionOptionalParams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship RegisterPosition fail managed');});Puship.Common.Log('Registering Position...');var request=new XMLHttpRequest();Puship.Common.Log('AppId:'+positionAppKey);var deviceId=positionAppKey.toString()+"_"+privateInstanceIdentifier;Puship.Common.Log('DeviceIdentifier:'+deviceId);var getstr=Puship.Domain+"services/puship.svc/RegisterPosition?AppId='"+positionAppKey+"'&DeviceIdentifier='"+deviceId
+"'&Latitude="+position.coords.latitude
+"&Longitude="+position.coords.longitude
+"&Accuracy="+position.coords.accuracy
+"&TimeStamp=datetime'"+isodatestring+"'";if(position.coords.speed)getstr+="&Speed="+position.coords.speed;if(position.coords.heading)getstr+="&Heading="+position.coords.heading;if(position.coords.altitude)getstr+="&Altitude="+position.coords.altitude;if(position.coords.altitudeAccuracy)getstr+="&AltitudeAccuracy="+position.coords.altitudeAccuracy;getstr+='&$format=json';Puship.Common.Log('RequestTo:'+getstr);request.open('GET',getstr,true);request.onreadystatechange=function(){if(request.readyState==4){Puship.Common.Log('Processing responce');if(request.status==200||request.status==201){try{var code=JSON.parse(request.responseText).d.RegisterPosition;if(code==200){Puship.Common.Log('Position Registered succesfully');pSuccessCallBack(this);}else{Puship.Common.Log('Error during registration position execution');WriteResponceStatus(code);pFailCallBack(this);}}catch(e){Puship.Common.Log('Error during responce parsing'+this.statusText);pFailCallBack(e);};}else{Puship.Common.Log('Error during call to registration position'+this.statusText);pFailCallBack(this);}}}
Puship.Common.Log('Calling RegisterPosition endpoint');request.send();}
function currentPositionError(error){var pFailCallBack=DefaultValue(positionOptionalParams.failCallback,function(pushipresult){Puship.Common.Log('Internal puship RegisterPosition fail managed');});Puship.Common.Log('code: '+error.code+'\n'+'message: '+error.message+'\n');pFailCallBack(error);}
function Log(l){if(Puship.EnableLog==true){console.log(l);}}
function GetCurrentOs(){if(privateCurrentPlatform==null){var cPlatform=device.platform;Puship.Common.Log("returned value as: "+cPlatform);if(cPlatform.indexOf("Android")>=0){privateCurrentPlatform=Puship.OS.ANDROID;}
else if(cPlatform.indexOf("Win")>=0){privateCurrentPlatform=Puship.OS.WP;}
else if(cPlatform.indexOf("iPhone")>=0||cPlatform.indexOf("iPad")>=0||cPlatform.indexOf("iOS")>=0){privateCurrentPlatform=Puship.OS.IOS;}
else{privateCurrentPlatform=Puship.OS.BLACKBERRY;}}
return privateCurrentPlatform;}
function Clean(){var cOS=GetCurrentOs();if(cOS==Puship.OS.ANDROID){}
else if(cOS==Puship.OS.WP){}
else if(cOS==Puship.OS.IOS){Puship.APNS.setApplicationIconBadgeNumber(0);}
else{}}
function ISODateString(d){return d.getUTCFullYear()+'-'
+pad(d.getUTCMonth()+1)+'-'
+pad(d.getUTCDate())+'T'
+pad(d.getUTCHours())+':'
+pad(d.getUTCMinutes())+':'
+pad(d.getUTCSeconds())+'Z';}
function pad(n){return n<10?'0'+n:n;}
return{OnPushReceived:OnPushReceived,NotifyPush:NotifyPush,RegisterOnPuship:RegisterOnPuship,AddTagFilter:AddTagFilter,RemoveTagFilter:RemoveTagFilter,CleanTagFilter:CleanTagFilter,GetTagFilters:GetTagFilters,GetPushMessages:GetPushMessages,DeletePushMessage:DeletePushMessage,GetPushMessagesByDevice:GetPushMessagesByDevice,GetCurrentOs:GetCurrentOs,Clean:Clean,Log:Log,UnRegister:UnRegister,RegisterCurrentPosition:RegisterCurrentPosition,GetAppId:GetAppId,DefaultValue:DefaultValue,IsNullOrEmpty:IsNullOrEmpty,GetURLParameter:GetURLParameter};}();window.onbeforeunload=function(e){Puship.Common.Log('Unloading...');if(Puship.gcmregid.length>0){Puship.Common.Log('Local unregistering app...');if(window.plugins&&window.plugins.GCM){Puship.Common.Log('Try unregisterding GCM...');Puship.GCM.UnRegister(function(){Puship.Common.Log("unregistered done");},function(){Puship.Common.Log("unregisteder error");});Puship.Common.Log('Try unregisterding GCM... Called');}}};